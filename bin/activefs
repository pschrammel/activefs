#!/usr/bin/env ruby

require 'pathname'
root=Pathname.new(File.expand_path(File.dirname(__FILE__)+'/..'))
$: << root.join('lib')
require('activefs')

cmd=ARGV[0]

case cmd
  when "index_list"
    repo=Activefs::LocalRepo.open(ARGV[1])
    repo.index.each do |entry|
      p entry
    end
  when "heads"
    repo=Activefs::LocalRepo.open(ARGV[1])
    repo.heads.each do |name, hash|
      puts "#{name} : #{hash}"
    end
  when "head"
    repo=Activefs::LocalRepo.open(ARGV[1])
    puts repo.head(ARGV[2])
  when "unpack"
    repo=Activefs::LocalRepo.open(ARGV[1])
    entry=repo.index.at(ARGV[2])
    content=repo.get(entry)
    puts content
  when "unpack_p"
    repo=Activefs::LocalRepo.open(ARGV[1])
    entry=repo.index.at(ARGV[2])
    content=repo.get(entry)
    p entry
    puts "EMPTY!" if entry.objectinfo.empty?
    out=case
              when entry.objectinfo.tree?
                Activefs::Tree.from_binary(content)
              when entry.objectinfo.blob?
                content
              when entry.objectinfo.commit?
                Activefs::Commit.from_binary(content)
              when entry.objectinfo.largeblob?
                Activefs::Largeblob.from_binary(content)
              else
                "unsupported"
            end


    p out
end
 